{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="bg-light">
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Report List</h4>
        <div>
            <a href="/" class="btn btn-outline-secondary me-2">Fill New Report</a>
            <a href="{% url 'user_dashboard' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>Office Name</th>
                            <th>Code</th>
                            <th>Region</th>
                            <th>Quarter</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = "/api/records";

// Function to mask sensitive fields
function maskSensitiveData(value) {
    if (!value || value === '-') return '-';
    const valueStr = String(value);
    if (valueStr.length <= 2) return valueStr;
    return valueStr.charAt(0) + '*'.repeat(valueStr.length - 2) + valueStr.charAt(valueStr.length - 1);
}

async function loadList() {
    try {
        const res = await fetch(API_URL);
        const data = await res.json();
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No records found</td></tr>';
            return;
        }
        data.forEach(r => {
            const tr = document.createElement('tr');
            const status = r.status === 'Draft' ? '<span class="badge bg-primary">Draft</span>' : '<span class="badge bg-success">Submitted</span>';
            let actionButtons = '';
            if (r.status === 'Draft') {
                actionButtons = `<button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); edit(${r.id})">Edit</button>`;
            } else if (r.edit_approved) {
                // If submitted but has approved edit request, show Edit button
                actionButtons = `<button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); edit(${r.id})">Edit</button>`;
            } else {
                actionButtons = `<button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); requestEdit(${r.id})">Request to Edit</button>`;
            }
            // Mask the office code in the list view
            const maskedCode = maskSensitiveData(r.officeCode);
            tr.innerHTML = `
                <td>${r.officeName || '-'}</td>
                <td>${maskedCode}</td>
                <td>${r.region || '-'}</td>
                <td>${r.quarter || '-'}</td>
                <td>${status}</td>
                <td>
                    ${actionButtons}
                    <button class="btn btn-sm btn-outline-primary ms-1" onclick="view(${r.id})">View</button>
                </td>
            `;
            tr.addEventListener('click', () => { if (r.status === 'Submitted') view(r.id); });
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error(err);
    }
}

function view(id) {
    // First check if the record can be edited (approved or not submitted)
    fetch(`/api/records/${id}/`)
        .then(res => res.json())
        .then(record => {
            if (record.can_edit) {
                // If editable, load it in the main form
                localStorage.setItem('editRecordId', String(id));
                window.location.href = '/';
            } else {
                // If not editable, show the read-only view
                window.location.href = `/reports/${id}/`;
            }
        })
        .catch(err => {
            console.error(err);
            // Fallback to read-only view
            window.location.href = `/reports/${id}/`;
        });
}

function edit(id) {
    // Store the id so index page can pick it up and populate form
    localStorage.setItem('editRecordId', String(id));
    window.location.href = '/';
}

function requestEdit(id) {
    const reason = prompt("Please enter the reason for requesting to edit this report:");
    if (reason === null) return; // User cancelled
    
    if (!reason.trim()) {
        alert("Please provide a reason for your request");
        return;
    }

    fetch(`/api/request-edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            record_id: id,
            reason: reason
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Request sent to HOD and Admin successfully!");
            loadList();
        } else {
            alert("Error: " + (data.error || "Failed to send request"));
        }
    })
    .catch(err => {
        console.error(err);
        alert("Failed to send request");
    });
}

window.addEventListener('DOMContentLoaded', loadList);
</script>
<script src="{% static 'js/script.js' %}"></script>
</body>
</html>
